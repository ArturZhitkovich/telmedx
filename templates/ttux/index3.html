{% extends "layout.html" %}
{% block metatitle %}telmedx - video feed{% endblock %}
{% block metadescription %}Looking for the next big thing in healtcare? Checkout telmedx.com{% endblock %}
{% block metastyle %}
		<style>
          html,
          body {
            height: 100%;
            /* The html and body elements cannot have any padding or margin. */
          }
          /* Wrapper for page content to push down footer */
          #wrap {
            min-height: 100%;
            height: auto;
            /* Negative indent footer by its height */
            margin: 0 auto -45px;
            /* Pad bottom by footer height */
            padding: 0 0 45px;
            background: url(static/bg-repeat.jpg) repeat   ; 
/*            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: cover;*/
          }
          /* Set the fixed height of the footer here */
          #footer {
            height: 45px;
            background-color: #000;
            color: #a0a0a0;
            text-align: center;
          }
          #footer-push{
            height: 10px;
            background-color: #202020;
          }
          .navbar-nav>li>a{
            padding-top: 25px;
            padding-bottom: 25px;
            font-size: 16px;
          }
          .navbar
          {
            background-color: #fff;
          }
          #hollywood
          {
            width: 100%;
          }
          #activeSnapshot{
            width: 100%;
          }
        </style>
{% endblock metastyle %}
{% block nav %}
<ul class="nav navbar-nav">
  <li><a href="/ttux/deviceList">Devices</a></li>
</ul>
<ul class="nav navbar-nav navbar-right">
  <li><a href="ttux/logout">Logout&nbsp;<span class="glyphicon glyphicon-off"></span></a></li>
</ul>
{% endblock nav %}
{% block content %}
    <div class="container" style="max-width:100%">
      <div class="row" style="margin-top: 100px;">
        <div class="col-sm-5 ">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Live Video - {{ dev.name }} <div style="display:inline;" id="stream_status">{{ OTUK }}: Waiting...</div>&nbsp;<a style="display:inline-block; color:white;" id="rot-btn" class="btn btn-sm btn-primary">Rotate +90</a></h3>
            </div>
            <div class="panel-body">
              <div id="stream">
                <canvas id="c" ></canvas>
                <!-- <img id="hollywood" src="/static/spinner.gif" ></img> -->
              </div>
              
              <button class="btn btn-primary btn-lg btn-block" onclick="takeSnapshotClicked()">Capture Image</button>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Saved Snapshots</h3>
            </div>
            <div id="pastSnapshots" style="min-height:100px;" class="panel-body">

            </div>
          </div>
        </div>
        <div class="col-sm-7">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Captured Images</h3>
            </div>
            <div class="panel-body">
            <div id="snapshots">
          <img id="activeSnapshot"  src="/static/spinner.gif" alt="" />
      
        </div>
            </div>
          </div>
        </div>
      </div>
      <canvas style="display:none;" id="b"></canvas>
    </div>	
{% endblock content %}
{% block afterjquery %}
<script type="text/javascript">

  //Frame counter & UI
  var ff=0;
  var lastFrame = 0;
  var fCounter = 0;
  var startTime = new Date();

  //video feed rotation
  var rotate = 90;//Default Rotation
  var ctx;
  var canvas;

  //large image rotation
  var ctx2;
  var canvas2;

  //Canvas support
  var canvasSupport; //true or false, defines if we should use canvas or img


  function isCanvasSupported(){
    var elem = document.createElement('canvas');
    return !!(elem.getContext && elem.getContext('2d'));
  }
  function inviteClicked() {
    jQuery.post("/ttux/invite");
  }
    
  function select(id) {
    $(".snapshot").css("border", "none");
    $("#" + id).css("border", "4px solid");
  }
  
  function showSnapshot(id) {
    var selected = $("#" + id);
    
    $("#activeSnapshot").attr("src", selected.attr("src"));
    select(id);
  }
  
  function takeSnapshotClicked() {
    $.post("/ttux/snapshot/{{ dev.name }}", null, function(data) {
      var dataUri = "data:image/jpeg;base64," + data.image;
      if( canvasSupport ){
        var image = new Image();
        image.src = dataUri;
        image.onload = function() {
          var cw = image.width, ch = image.height, cx = 0, cy = 0;
          //Calculate new canvas size and x/y coorditates for image
          switch(rotate){
            case 90:
              cw = image.height;
              ch = image.width;
              cy = image.height * (-1);
              break;
            case 180:
              cx = image.width * (-1);
              cy = image.height * (-1);
              break;
            case 270:
              cw = image.height;
              ch = image.width;
              cx = image.width * (-1);
              break;
          }
          console.log(rotate);
          
          //  Rotate image            
          canvas2.setAttribute('width', cw);
          canvas2.setAttribute('height', ch);
          ctx2.rotate(rotate * Math.PI / 180);
          ctx2.drawImage(image, cx, cy);//Display Image in Canvas
          dataUri = canvas2.toDataURL();
          console.log(dataUri);
          $("#activeSnapshot").attr("src", dataUri);
          var id = "snapshot-" + new Date().getTime().toString();
          var imageElement = "<img class=\"snapshot\" id=\"" + id + "\" src=\"" + dataUri + "\" width=\"75\" height=\"50\" onclick=\"window.parent.showSnapshot('" + id + "')\"> "
          
          $("#pastSnapshots").append(imageElement);
          
          select(id);
        }//End image.onload
      }else
      {
        $("#activeSnapshot").attr("src", dataUri);
        var id = "snapshot-" + new Date().getTime().toString();
        var imageElement = "<img class=\"snapshot\" id=\"" + id + "\" src=\"" + dataUri + "\" width=\"75\" height=\"50\" onclick=\"window.parent.showSnapshot('" + id + "')\"> "
        
        $("#pastSnapshots").append(imageElement);
        
        select(id);
      }
    });

    
    $("#activeSnapshot").attr("src", "/static/spinner.gif")
  }




  function frameOne_jq(){

    var r = $.ajax({//Go get frame
      url: "/ttux/lastFrame/{{ dev.name }}/" + lastFrame
    });
    
    r.done( function(msg) {
      var fnumber = msg.substring(0,8);
      lastFrame = fnumber;
      if (msg.substring(8).length > 0) {
          videoSrc = "data:image/jpg;base64," + msg.substring(8);
          if( canvasSupport ){
            var image = new Image();
            image.src = videoSrc;
            image.onload = function() {
              var cw = image.width, ch = image.height, cx = 0, cy = 0;
              //Calculate new canvas size and x/y coorditates for image
              switch(rotate){
                case 90:
                  cw = image.height;
                  ch = image.width;
                  cy = image.height * (-1);
                  break;
                case 180:
                  cx = image.width * (-1);
                  cy = image.height * (-1);
                  break;
                case 270:
                  cw = image.height;
                  ch = image.width;
                  cx = image.width * (-1);
                  break;
              }
              console.log(rotate);
              
              //  Rotate image            
              canvas.setAttribute('width', cw);
              canvas.setAttribute('height', ch);
              ctx.rotate(rotate * Math.PI / 180);
              ctx.drawImage(image, cx, cy);//Display Image in Canvas
            }//End image.onload
          }else{ //If canvas is not supported display in img tag
            $("#hollywood").attr('src',videoSrc);
          }

      };
      var now = new Date();
      var min = Math.floor( (now - startTime)/1000 );
      var sec = (now - startTime)%1000;
      
      $("#stream_status").html("- Connected: " + min + "." + sec + " f: " + fCounter );
      fCounter++; //Adds to frame couter

      frameOne_jq(); //Let the function call itself
    });

    // error handler, wait 1/2 second
    r.error( function(msg) {
      console.log("got error");
      setTimeout("frameOne_jq()", 500);
    });

  }   

  $(document).ready(function()
  {
    $("#rot-btn").click(function(){
      rotate = rotate+90;
      if( rotate == 360){
        rotate = 0;
      }
    });

    canvasSupport = isCanvasSupported();
    if ( ! canvasSupport ){
      $("#c").remove();
      $("#stream").html('<img id="hollywood" src="/static/spinner.gif" ></img>');
    }else{
      canvas = document.getElementById("c");
      ctx = canvas.getContext('2d');
      canvas2 = document.getElementById("b");
      ctx2 = canvas2.getContext('2d');
    }
    //Ask for the first frame
    frameOne_jq();
  });
  </script>
{% endblock afterjquery %}
