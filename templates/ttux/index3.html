{% extends "layout.html" %}
{% block metatitle %}telmedx - video feed{% endblock %}
{% block metadescription %}Looking for the next big thing in healtcare? Checkout telmedx.com{% endblock %}
{% block metastyle %}
		<style>
          html,
          body {
            height: 100%;
            /* The html and body elements cannot have any padding or margin. */
          }
          /* Wrapper for page content to push down footer */
          #wrap {
            min-height: 100%;
            height: auto;
            /* Negative indent footer by its height */
            margin: 0 auto -20px;
            /* Pad bottom by footer height */
            padding: 0 0 20px;
            background: url(static/img/brushedsteel-dk.jpg) no-repeat center center fixed; 
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: cover;
            /*background: url(static/img/bg-repeat.jpg) repeat; */
          }
          /* Set the fixed height of the footer here */
          #footer {
            height: 20px;
            background-color: #000;
            color: #a0a0a0;
            text-align: center;
          }
          #footer-push{
            height: 10px;
            background-color: #202020;
          }
          .navbar-nav>li>a{
            padding-top: 25px;
            padding-bottom: 25px;
            font-size: 16px;
          }
          .navbar
          {
            background-color: #fff;
          }
          #hollywood
          {
            width: 100%;
          }
          #activeSnapshot{
            height: 100%;
          }
          .icon-bar{
            background-color: black;
          }
          .navbar-toggle{
            border: 1px solid black;
            margin-top: 18px;
          }
          img.snapshot{
            margin-bottom: 4px;
          }
          #c{
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
          }
          #first-row{
            margin-top: 100px;
          }
          @media all and (max-width: 992px) and (min-width: 768px) {
            /*#sidebar ul li a {
              padding-left: 21px;
              background: url(../images/email.png) left center no-repeat;
            }*/
            .nav{
              height: 45px;
            }
            .navbar-brand{
              padding: 10px;
              /*border: 1px solid red;*/
            }
            .navbar-brand img{
              margin-top: 3px;
              height: 25px;
              /*border: 1px solid red;*/
            }
            .navbar-nav>li>a {
              padding-top: 16px;
              padding-bottom: 15px;
              font-size: 14px;
            }
            #first-row{
              margin-top: 70px;
            }
          }
          #capture-snaper .panel-body{
            padding: 0px;
          }
          .currently-panning{
            pointer-events:none;          /* THIS IS THE TRICK YOU SEEK */
          }
          #drawing-layer{
            position: absolute;
            z-index: 4;
          }
          .hundo{
            width: 100%;
          }
        </style>
        <!--[if IE]>
      <style type="text/css">

        .currently-panning {
          background:none !important;
        }

        </style>
    <![endif]-->
    <link rel="stylesheet" href="/static/fonts/flaticon.css">
{% endblock metastyle %}
{% block nav %}
<ul class="nav collapse navbar-collapse navbar-nav">
  <li><a style="padding-bottom: 5px; padding-top: 10px;" href="/ttux/deviceList"><img style="height: 55px;" src="/static/img/responsive.png"></a></li>
</ul>
<ul class="nav collapse navbar-collapse navbar-nav navbar-right">
  <li><a style="padding-top: 20px; padding-bottom: 11px;" href="ttux/logout">
    <span style="font-size: 35px; color: black;" class="glyphicon glyphicon-off"></span>
  </a></li>
</ul>
{% endblock nav %}
{% block content %}
    <div class="container" style="max-width:100%;">
      <div id="first-row" class="row" style="">
        <div class="col-md-5 col-sm-5 ">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Live Video - {{ dev.name }} <div style="display:inline;" id="stream_status">{{ OTUK }}: Waiting...</div>&nbsp;
              <div style="float: right;">
                <button id="rotate-left" class="btn btn-default">
                  <img style="height: 30px;" src="/static/img/rotating1.png">
                </button>
                <button id="rotate-right" class="btn btn-default">
                  <img style="height: 30px;" src="/static/img/rotating1-opp.png">
                </button>
              </div>
              <div class="clearfix"></div>
              </h3>
            </div>
            <div class="panel-body">
              <div id="stream">
                <canvas id="c"  ></canvas>
                <!-- <img id="hollywood" src="/static/spinner.gif" ></img> -->
              </div>
              <br>
              <div id="" class="row">
                <div class="text-center">
                  <div class="btn-group">
                    <button id="camera-toggle" style="display:none;" type="button" class="btn btn-default" style="width: 86px; height: 64px;">
                      <div id="camera-toggle-icon">
                        <img style="height: 50px;" src="/static/img/switch19.png">
                      </div>
                      <div id="camera-front-icon">
                        <span style="font-size: 40px; height: 50px; padding-top: 5px" class="glyphicon glyphicon-phone"></span>
                      </div> 
                      <div id="camera-back-icon">
                        <span style="font-size: 40px; height: 50px; padding-top: 5px;" class="glyphicon glyphicon-facetime-video"></span>
                      </div> 
                    </button>


                    <button type="button" id="capture-button" class="btn btn-default"><img style="height: 50px; cursor:pointer;"  src="static/img/Capture_Button.png" /></button>
                    <button id="flash-toggle" type="button" style="width: 86px; display:none;" class="btn btn-default"><img style="height: 50px;" src="/static/img/flash3.png"> </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title"><img style="height: 30px;" src="/static/img/images10.png"></h3>
            </div>
              <div id="pastSnapshots" style="min-height:100px;" class="panel-body">

            </div>
          </div>
        </div>
        <div class="col-md-7 col-sm-7">
          <div  id="capture-snaper" class="panel panel-default">
            <div class="panel-heading" id="cap-head">
              <h3 class="panel-title"><img style="height: 50px;" src="/static/img/picture11.png"> 
                <!-- <img style="height: 50px;" src="/static/img/hd3.png">      -->
                <!-- Button trigger modal -->
 <!--                <button id="open-editor" class="btn btn-default btn-sm" data-toggle="modal" data-target="#myModal">
                  <img style="height: 30px" src="/static/img/page14.png">
                </button> -->
                <div style="float: right;">
                  <div style="clear: both; margin-top: 3px;">
                    <div class="btn-group">
                      <button class="btn btn-sm btn-default zoom-in" >
                        <img style="height: 30px;" src="/static/img/zoom7.png">
                      </button>
                      <button class="btn btn-sm btn-default zoom-out" >
                        <img style="height: 30px;" src="/static/img/minus13.png">
                      </button>
                    </div>

                    <!-- <div class="btn-group"> -->
<!--                       <button class="btn btn-sm btn-default zoom-in" >
                        <img style="height: 30px;" src="/static/img/download61.png">
                      </button> -->
                    <!-- </div> -->
                  </div>
                </div>
              </h3>
            </div>
            <div id="cap-body" class="panel-body">
              <div style="height:100%" id="snapshots" style="position:relative;">
                
                <div class="panzoom">
                  <img id="activeSnapshot"   alt="" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <canvas style="display:none;" id="b"></canvas>
    </div>	


<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Modal title</h4>
      </div>
      <div class="modal-body">
        <div id="drawing-layer"></div>
        <img id="editSnapshot" class="hundo" src="/static/img/spinner.gif">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>
{% endblock content %}
{% block afterjquery %}
<script type="text/javascript" src="/static/js/browser.js"></script>
<script type="text/javascript" src="/static/js/jquery.panzoom.min.js"></script>
<script type="text/javascript" src="/static/js/raphael.js"></script>
<script type="text/javascript" src="/static/js/json2.js"></script>
<script type="text/javascript" src="/static/js/raphael.sketchpad.js"></script>
<!-- <script type="text/javascript" src="/static/js/jquery.sketch.min.js"></script> -->
      <script>


      
      </script>
<script type="text/javascript">


  //Frame counter & UI
  var ff=0;
  var lastFrame = 0;
  var fCounter = 0;
  var startTime = new Date();

  //video feed rotation
  var rotate = 90;//Default Rotation
  var ctx;
  var canvas;

  //Stream box
  var streamBox;

  //large image rotation
  var ctx2;
  var canvas2;

  //Canvas support
  var canvasSupport; //true or false, defines if we should use canvas or img

  //Sketchpad
  var sketchpad;

  //Flash
  var flashToggeling = false;

  //Camera
  var frontCamera = false;
  var cameraToggeling = false;

  function isCanvasSupported(){
    var elem = document.createElement('canvas');
    return !!(elem.getContext && elem.getContext('2d'));
  }
  function inviteClicked() {
    jQuery.post("/ttux/invite");
  }
    
  function select(id) {
    $(".snapshot").css("border", "none");
    $("#" + id).css("border", "4px solid");
  }
  
  function showSnapshot(id) {
    var selected = $("#" + id);
    
    $("#activeSnapshot").attr("src", selected.attr("src"));
    select(id);
  }
  
  function takeSnapshotClicked() {
    $.post("/ttux/snapshot/{{ dev.name }}", null, function(data) {
      var dataUri = "data:image/jpeg;base64," + data.image;
      if( canvasSupport ){
        var image = new Image();
        image.src = dataUri;
        image.onload = function() {
          var cw = image.width, ch = image.height, cx = 0, cy = 0; ratio = cw/ch;
          //Calculate new canvas size and x/y coorditates for image
          switch(rotate){
            case 90:
              cw = image.height;
              ch = image.width;
              cy = image.height * (-1);
              break;
            case 180:
              cx = image.width * (-1);
              cy = image.height * (-1);
              break;
            case 270:
              cw = image.height;
              ch = image.width;
              cx = image.width * (-1);
              break;
          }
          console.log(rotate);
          
          //Rotate image            
          canvas2.setAttribute('width', cw);
          canvas2.setAttribute('height', ch);
          ctx2.rotate(rotate * Math.PI / 180);
          ctx2.drawImage(image, cx, cy);//Display Image in Canvas
          dataUri = canvas2.toDataURL();
          console.log(dataUri);
          $("#activeSnapshot").attr("src", dataUri);
          //Center the image
          $("#activeSnapshot").css("margin-left", ($("#snapshots").innerWidth()-$("#activeSnapshot").innerWidth())/2 );
          var id = "snapshot-" + new Date().getTime().toString();
          if( rotate == 90 || rotate == 270) {
            smwidth = 45;
            smheight = 45* ratio;
          }else{
            smwidth = 45*ratio;
            smheight = 45;
          }
          var imageElement = "<img class=\"snapshot\" id=\"" + id + "\" src=\"" + dataUri + "\" width=\""+String(smwidth)+"\" height=\""+String(smheight)+"\" onclick=\"window.parent.showSnapshot('" + id + "')\"> "
          
          $("#pastSnapshots").append(imageElement);
          
          select(id);
        }//End image.onload
      }else
      {
        $("#activeSnapshot").attr("src", dataUri);
        var id = "snapshot-" + new Date().getTime().toString();
        var imageElement = "<img class=\"snapshot\" id=\"" + id + "\" src=\"" + dataUri + "\" width=\"75\" height=\"50\" onclick=\"window.parent.showSnapshot('" + id + "')\"> "
        
        $("#pastSnapshots").append(imageElement);
        
        select(id);
      }
    });
  }
  function flashOn(){
    $("#flash-toggle").addClass('active');
    $("#flash-toggle").html('<img style="height: 50px;" src="/static/img/flash1.png">')
  }
  function flashOff(){
    $("#flash-toggle").removeClass('active');
    $("#flash-toggle").html('<img style="height: 50px;" src="/static/img/flash3.png">')
  }
  function toggle_jq(){
    flashToggeling = true;
    var r = $.ajax({
      url: "/ttux/flashlight/{{ dev.name }}"
    });

    r.done( function(data){
      console.log(data);
      flashToggeling = false;
      if( data.status == 'on' ){
        flashOn();
      }else if( data.status == 'off'){
        flashOff();
      }else{
        console.log("Something went wrong with the flash");
      }
    });
  }
  function toggle_camera_jq(){
    cameraToggeling = true;

    var r = $.ajax({
      url: "/ttux/flipcamera/{{ dev.name }}"
    });

    r.done( function(data){
      console.log(data);
      cameraToggeling = false;
      if( data.status == 'front' ){
        frontCamera = true;
        $("#camera-toggle div:not('#camera-front-icon')").hide();
        $("#camera-front-icon").show();
        $("#flash-toggle").addClass('disabled');

      }else if (data.status == 'back'){
        frontCamera = false;
        $("#camera-toggle div:not('#camera-back-icon')").hide();
        $("#camera-back-icon").show();
        $("#flash-toggle").removeClass('disabled');

      }else{
        console.log("Something went wrong with the camera");
      }
    });
  }
  function frameOne_jq(){

    var r = $.ajax({//Go get frame
      url: "/ttux/lastFrame/{{ dev.name }}/" + lastFrame
    });
    
    r.done( function(msg) {
      // console.log(msg.substring(0,15));
      var fnumber = msg.substring(0,8);
      var begin_img_data = 8;
      if( msg.substring(0,2) == '!!'){
        begin_end = msg.indexOf('!!', 2)
        control = $.parseJSON( msg.substring(2, parseInt( begin_end )   ) )
        if( control.command == 'update_controls' ){
          if(control.parameters.indexOf('flash') != -1){
            $("#flash-toggle").show();
          }
          if(control.parameters.indexOf('flip') != -1){
            $("#camera-toggle").show();
          }
        }
        fnumber = msg.substring( parseInt(begin_end)+ 2 ,parseInt(begin_end)+ 10);
        begin_img_data = parseInt(begin_end)+ 10;
      }
      
      lastFrame = fnumber;
      if (msg.substring(8).length > 0) {
          videoSrc = "data:image/jpg;base64," + msg.substring(begin_img_data);
          if( canvasSupport ){
            var image = new Image();
            image.src = videoSrc;
            image.onload = function() {
              var cw = image.width, ch = image.height, cx = 0, cy = 0;
              //Calculate new canvas size and x/y coorditates for image
              switch(rotate){
                case 90:
                  cw = image.height;
                  ch = image.width;
                  cy = image.height * (-1);
                  break;
                case 180:
                  cx = image.width * (-1);
                  cy = image.height * (-1);
                  break;
                case 270:
                  cw = image.height;
                  ch = image.width;
                  cx = image.width * (-1);
                  break;
              }
              // console.log(rotate);
              
              //  Rotate image            
              canvas.setAttribute('width', cw);
              canvas.setAttribute('height', ch);
              ctx.rotate(rotate * Math.PI / 180);
              if( cw > streamBox.innerWidth() )//Scales the image down if it won't fit in the box
              {
                ctx.scale(streamBox.innerWidth()/cw,streamBox.innerWidth()/cw);
                streamBox.css("height",ch*streamBox.innerWidth()/cw+"px");
              }
              ctx.drawImage(image, cx, cy);//Display Image in Canvas
            }//End image.onload
          }else{ //If canvas is not supported display in img tag
            $("#hollywood").attr('src',videoSrc);
          }

      // };
      var now = new Date();
      var min = Math.floor( (now - startTime)/1000 );
      var sec = (now - startTime)%1000;
      
      $("#stream_status").html("- " + min + "." + sec + " f: " + fCounter );
      fCounter++; //Adds to frame couter
      }
      frameOne_jq(); //Let the function call itself
    });

    // error handler, wait 1/2 second
    r.error( function(msg) {
      console.log("got error");
      setTimeout("frameOne_jq()", 500);
    });

  }   
  (function() {
    var $section = $('#capture-snaper').first();
    $section.find('.panzoom').panzoom({
      $zoomIn: $section.find(".zoom-in"),
      $zoomOut: $section.find(".zoom-out"),
      $zoomRange: $section.find(".zoom-range"),
      $reset: $section.find(".reset")
    });
  })();

  $(document).ready(function()
  {
    $("#open-editor").click(function(){
      console.log("Clicked");
      setTimeout( function(){
        $('#editSnapshot').removeClass('hundo');
        $("#editSnapshot").attr('src',$("#activeSnapshot").attr('src'));
        var marginleft= ( $("#editSnapshot").parent(".modal-body").innerWidth() - $("#editSnapshot").innerWidth())/2;
        $("#editSnapshot").css("margin-left",  marginleft );
        $("#drawing-layer").css("marginleft", marginleft );
        $("#drawing-layer").css("height", $("#editSnapshot").height());
        $("#drawing-layer").css("width", $("#editSnapshot").width());
      }, 1000);
    });
    $("#flash-toggle").click(function(){
      if( flashToggeling || frontCamera || cameraToggeling){
        return;
      }
      toggle_jq();
      if( $(this).hasClass('active') ){
        flashOff();
      }else{
        flashOn();
      }
    });
    $("#flash-toggle").css("width",$("#flash-toggle").outerWidth());
    // $("#capture-snaper").css("border","1px solid red");
    var snaperh = $(window).height() -110 -60
    $("#capture-snaper").css("height",snaperh);
    $("#cap-body").css("height",snaperh - $("#cap-head").outerHeight());

    // $("#drawing-layer").attr("height",$("#activeSnapshot").innerHeight());
    // $("#drawing-layer").attr("width",$("#activeSnapshot").innerWidth());

      // sketchpad = Raphael.sketchpad("drawing-layer", {
      //   width: 400,
      //   height: 400,
      //   editing: true
      // });

    // $("[data-tool='marker'],[data-tool='eraser'] ").attr('href',document.URL+"#drawing-layer")
    // $('#drawing-layer').sketch({defaultColor: "#ff0"});

    // $("#activeSnapshot").height(snaperh - $("#cap-head").outerHeight()-30)
    var previous_camera_toggle_state;
    $("#camera-toggle").hover(function(){
      previous_camera_toggle_state = $(this).find('div:visible').attr('id');
      $(this).find('div').not('#camera-toggle-icon').hide();
      $(this).find('#camera-toggle-icon').show();
    }, function(){
      $(this).find('div').hide();
      $(this).find('#'+previous_camera_toggle_state).show();
    });
    $("#camera-toggle div:not('#camera-back-icon')").hide();
    $("#camera-toggle").click(function(){
      if( cameraToggeling ){
        console.log('I\'m toggleing');
        return;
      }
      flashOff();
      toggle_camera_jq();
      if( ! frontCamera ){
        $("#camera-toggle div:not('#camera-front-icon')").hide();
        $("#flash-toggle").addClass('disabled');
      }else{
        $("#camera-toggle div:not('#camera-back-icon')").hide();
        $("#flash-toggle").removeClass('disabled');

      }
    });


    $('#myModal').bind('hidden.bs.modal', function () {
      $("html").css("margin-right", "0px");
    });
    $('#myModal').bind('show.bs.modal', function () {
      $("html").css("margin-right", "-15px");
    });
    $("#rotate-right").click(function(){
      rotate = rotate+90;
      if( rotate == 360){
        rotate = 0;
      }
    });
    $("#rotate-left").click(function(){
      rotate = rotate-90;
      if( rotate == -90){
        rotate = 270;
      }
    });
    $("#capture-button").click(function(){
      takeSnapshotClicked();
    });

    canvasSupport = isCanvasSupported();
    if ( ! canvasSupport ){
      $("#c").remove();
      $("#stream").html('<img id="hollywood" src="/static/img/spinner.gif" ></img>');
    }else{
      canvas = document.getElementById("c");
      ctx = canvas.getContext('2d');
      canvas2 = document.getElementById("b");
      ctx2 = canvas2.getContext('2d');
    }
    streamBox = $("#stream");
    // streamBox.css("width","250px");
    streamBox.css("overflow","hidden");


    //Ask for the first frame
    frameOne_jq();
  });
  </script>
{% endblock afterjquery %}
